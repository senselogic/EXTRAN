<meta charset="utf-8">
<style>
    *
    {
        padding : 0;
        margin : 0;
    }

    table
    {
        border-collapse : collapse;
    }
</style>
<table>
    <tbody>
        <tr>
            <td colspan="2">
                <textarea id="OldText" placeholder="Old text" style="width:49vw;height:25vh"></textarea>
            </td>
            <td colspan="2">
                <textarea id="NewText" placeholder="New text" style="width:49vw;height:25vh"></textarea>
            </td>
        </tr>
        <tr>
            <td>
                <input id="LinePrefix" type="text" placeholder="Line prefix" style="width:24.5vw;height:5vh"/>
            </td>
            <td>
                <input id="LineSuffix" type="text" placeholder="Line suffix" style="width:24.5vw;height:5vh"/>
            </td>
            <td>
                <input id="PhrasePrefix" type="text" placeholder="Phrase prefix" style="width:24.5vw;height:5vh"/>
            </td>
            <td>
                <input id="PhraseSuffix" type="text" placeholder="Phrase suffix" style="width:24.5vw;height:5vh"/>
            </td>
        </tr>
        <tr>
            <td>
                <input id="OldIdentifier" type="text" placeholder="Old identifier" style="width:24.5vw;height:5vh"/>
            </td>
            <td>
                <input id="NewIdentifier1" type="text" placeholder="New identifier" style="width:24.5vw;height:5vh"/>
            </td>
            <td>
                <input id="NewIdentifier2" type="text" placeholder="New identifier" style="width:24.5vw;height:5vh"/>
            </td>
            <td>
                <input id="NewIdentifier3" type="text" placeholder="New identifier" style="width:24.5vw;height:5vh"/>
            </td>
        </tr>
        <tr>
            <td>
                <input id="OldLineOffset" type="text" placeholder="" readonly style="width:24.5vw;height:5vh"/>
            </td>
            <td>
                <input id="NewLineOffset1" type="text" placeholder="New line offset" style="width:24.5vw;height:5vh"/>
            </td>
            <td>
                <input id="NewLineOffset2" type="text" placeholder="New line offset" style="width:24.5vw;height:5vh"/>
            </td>
            <td>
                <input id="NewLineOffset3" type="text" placeholder="New line offset" style="width:24.5vw;height:5vh"/>
            </td>
        </tr>
        <tr>
            <td>
                <textarea id="OldTranslatedText" placeholder="Old translated text" onInput="SetRowCount( this )" style="width:24.5vw;height:50vh"></textarea>
            </td>
            <td>
                <textarea id="NewTranslatedText1" placeholder="New translated text" onInput="SetRowCount( this )" style="width:24.5vw;height:50vh"></textarea>
            </td>
            <td>
                <textarea id="NewTranslatedText2" placeholder="New translated text" onInput="SetRowCount( this )" style="width:24.5vw;height:50vh"></textarea>
            </td>
            <td>
                <textarea id="NewTranslatedText3" placeholder="New translated text" onInput="SetRowCount( this )" style="width:24.5vw;height:50vh"></textarea>
            </td>
        </tr>
        <tr>
            <td>
                <input id="OldRowCount" placeholder="0" readonly style="width:24.5vw;height:5vh"/>
            </td>
            <td>
                <input id="NewRowCount1" placeholder="0" readonly style="width:24.5vw;height:5vh"/>
            </td>
            <td>
                <input id="NewRowCount2" placeholder="0" readonly style="width:24.5vw;height:5vh"/>
            </td>
            <td>
                <input id="NewRowCount3" placeholder="0" readonly style="width:24.5vw;height:5vh"/>
            </td>
        </tr>
        <tr>
            <td>
                <button onclick="Extract()" style="font-size:2vh">Extract</button>
                <button onclick="Integrate()" style="font-size:2vh">Integrate</button>
            </td>
        </tr>
    </tbody>
</table>
<script>
    function SetRowCount(
        phrase_array
        )
    {
        document.getElementById( phrase_array.id.split( "TranslatedText" ).join( "RowCount" ) ).value
            = phrase_array.value.split( "\n" ).length;
    }

    // ~~

    function GetPartArray(
        line,
        line_prefix,
        line_suffix,
        phrase_prefix,
        phrase_suffix
        )
    {
        if ( line_prefix !== "" )
        {
            if ( line.startsWith( line_prefix ) )
            {
                line = line.substring( line_prefix.length );
            }
            else
            {
                return [];
            }
        }

        if ( line_suffix !== "" )
        {
            if ( line.endsWith( line_suffix ) )
            {
                line = line.substring( 0, line.length - line_suffix.length );
            }
            else
            {
                return [];
            }
        }

        if ( phrase_prefix !== "" )
        {
            phrase_prefix_character_index = line.indexOf( phrase_prefix );

            if ( phrase_prefix_character_index >= 0 )
            {
                phrase_prefix = line.substring( 0, phrase_prefix_character_index + phrase_prefix.length );
                line = line.substring( phrase_prefix.length );
            }
            else
            {
                return [];
            }
        }

        if ( phrase_suffix !== "" )
        {
            phrase_suffix_character_index = line.indexOf( phrase_suffix );

            if ( phrase_suffix_character_index >= 0 )
            {
                phrase_suffix = line.substring( phrase_suffix_character_index );
                line = line.substring( 0, phrase_suffix_character_index );
            }
            else
            {
                return [];
            }
        }

        return [ line_prefix + phrase_prefix, line, phrase_suffix + line_suffix ];
    }

    // ~~

    function Extract()
    {
        var
            line_prefix,
            line_suffix,
            old_line,
            old_line_array,
            old_line_index,
            old_part_array,
            old_phrase_array,
            old_translated_text_element,
            phrase_prefix,
            phrase_suffix;

        old_line_array = document.getElementById( "OldText" ).value.split( "\n" );

        line_prefix = document.getElementById( "LinePrefix" ).value;
        line_suffix = document.getElementById( "LineSuffix" ).value;

        phrase_prefix = document.getElementById( "PhrasePrefix" ).value;
        phrase_suffix = document.getElementById( "PhraseSuffix" ).value;

        old_phrase_array = [];

        for ( old_line_index = 0;
              old_line_index < old_line_array.length;
              ++old_line_index )
        {
            old_line = old_line_array[ old_line_index ];
            old_part_array = GetPartArray( old_line, line_prefix, line_suffix, phrase_prefix, phrase_suffix );

            if ( old_part_array.length == 3 )
            {
                old_phrase_array.push( old_part_array[ 1 ] );
            }
        }

        old_translated_text_element = document.getElementById( "OldTranslatedText" );
        old_translated_text_element.value = old_phrase_array.join( "\n" );

        SetRowCount( old_translated_text_element );
    }

    // ~~

    function GetLineOffset(
        text
        )
    {
        if ( text === "" )
        {
            return 1;
        }
        else
        {
            return text * 1;
        }
    }

    // ~~

    function Integrate()
    {
        var
            language_index,
            line_prefix,
            line_suffix,
            new_line,
            new_line_array,
            new_line_index,
            new_line_offset,
            new_line_offset_array,
            new_identifier_array,
            new_phrase_array_array,
            phrase_index,
            new_translated_text_array,
            old_identifier,
            old_line,
            old_line_array,
            old_line_index,
            old_part_array,
            old_phrase_array,
            old_translated_text,
            phrase_prefix,
            phrase_suffix;

        old_line_array = document.getElementById( "OldText" ).value.split( "\n" );
        new_line_array = old_line_array.slice();

        line_prefix = document.getElementById( "LinePrefix" ).value;
        line_suffix = document.getElementById( "LineSuffix" ).value;

        phrase_prefix = document.getElementById( "PhrasePrefix" ).value;
        phrase_suffix = document.getElementById( "PhraseSuffix" ).value;

        old_identifier = document.getElementById( "OldIdentifier" ).value;
        new_identifier_array
            = [
                  document.getElementById( "NewIdentifier1" ).value,
                  document.getElementById( "NewIdentifier2" ).value,
                  document.getElementById( "NewIdentifier3" ).value
              ];

        new_line_offset_array
            = [
                  document.getElementById( "NewLineOffset1" ).value,
                  document.getElementById( "NewLineOffset2" ).value,
                  document.getElementById( "NewLineOffset3" ).value
              ];

        old_translated_text = document.getElementById( "OldTranslatedText" ).value;
        new_translated_text_array
            = [
                  document.getElementById( "NewTranslatedText1" ).value,
                  document.getElementById( "NewTranslatedText2" ).value,
                  document.getElementById( "NewTranslatedText3" ).value
              ];

        old_phrase_array = old_translated_text.split( "\n" );
        new_phrase_array_array
            = [
                  new_translated_text_array[ 0 ].split( "\n" ),
                  new_translated_text_array[ 1 ].split( "\n" ),
                  new_translated_text_array[ 2 ].split( "\n" )
              ];

        phrase_index = 0;

        new_line_index = 0;

        for ( old_line_index = 0;
              old_line_index < old_line_array.length;
              ++old_line_index )
        {
            old_line = old_line_array[ old_line_index ];
            old_part_array = GetPartArray( old_line, line_prefix, line_suffix, phrase_prefix, phrase_suffix );

            if ( old_part_array.length == 3 )
            {
                for ( language_index = 0;
                      language_index < 3;
                      ++language_index )
                {
                    if ( new_translated_text_array[ language_index ] !== "" )
                    {
                        if ( phrase_index < new_phrase_array_array[ language_index ].length
                             && new_phrase_array_array[ language_index ].length === old_phrase_array.length )
                        {
                            new_line_offset = new_line_offset_array[ language_index ];

                            if ( new_line_offset === "" )
                            {
                                new_line_offset = 1;
                            }
                            else
                            {
                                new_line_offset *= 1;
                            }

                            new_line
                                = old_part_array[ 0 ].split( old_identifier ).join( new_identifier_array[ language_index ] )
                                  + new_phrase_array_array[ language_index ][ phrase_index ]
                                  + old_part_array[ 2 ].split( old_identifier ).join( new_identifier_array[ language_index ] );

                            new_line_array.splice(
                                new_line_index + new_line_offset,
                                0,
                                new_line
                                );

                            if ( new_line_offset <= 1 )
                            {
                                ++new_line_index;
                            }
                        }
                        else
                        {
                            alert( "Invalid line count : " + new_phrase_array_array[ language_index ].length );
                        }
                    }
                }

                ++phrase_index;
            }

            ++new_line_index;
        }

        document.getElementById( "NewText" ).value = new_line_array.join( "\n" );
    }
</script>
